(function(e){e.fn.collection=function(t){var Q={container:'body',allow_up:!0,up:'<a href="#">&#x25B2;</a>',before_up:function(e,t){return!0},after_up:function(e,t){return!0},allow_down:!0,down:'<a href="#">&#x25BC;</a>',before_down:function(e,t){return!0},after_down:function(e,t){return!0},allow_add:!0,add:'<a href="#">[ + ]</a>',before_add:function(e,t){return!0},after_add:function(e,t){return!0},allow_remove:!0,remove:'<a href="#">[ - ]</a>',before_remove:function(e,t){return!0},after_remove:function(e,t){return!0},allow_duplicate:!1,duplicate:'<a href="#">[ # ]</a>',before_duplicate:function(e,t){return!0},after_duplicate:function(e,t){return!0},before_init:function(e){},after_init:function(e){},min:0,max:100,add_at_the_end:!1,prefix:'collection',prototype_name:'__name__',name_prefix:null,elements_selector:'> div',elements_parent_selector:'%id%',children:null,init_with_n_elements:0,hide_useless_buttons:!0,drag_drop:!0,drag_drop_options:{'placeholder':'ui-state-highlight'},drag_drop_start:function(e,t){return!0},drag_drop_update:function(e,t){return!0},custom_add_location:!1,fade_in:!0,fade_out:!0,position_field_selector:null,preserve_names:!1};var y=function(){var e=''+Math.random()*1000*new Date().getTime();return e.replace('.','').split('').sort(function(){return 0.5-Math.random()}).join('')},l=function(t,n){if(!n.attr('id')){var i;do{i=t+'_'+y()}
while(e('#'+i).length>0);n.attr('id',i)};return n.attr('id')},c=function(t){try{var n=e(t)}catch(i){return null};if(n.length===0){return null}
else if(n.is('input[type="checkbox"]')){return(n.prop('checked')===!0?!0:!1)}
else if(n.is('input[type="radio"]')&&n.attr('name')!==undefined){return e('input[name="'+n.attr('name')+'"]:checked').val()}
else if(n.prop('value')!==undefined){return n.val()}
else{return n.html()}},d=function(t,n,i){try{var a=e(t)}catch(r){return};if(a.length===0){return}
else if(a.is('input[type="checkbox"]')){if(n){a.attr('checked',!0)}
else{a.removeAttr('checked')}}
else if(a.prop('value')!==undefined){if(i){a.attr('value',n)}
else{a.val(n)}}
else{a.html(n)}},n=function(e){return undefined===e||e},r=function(e){return(e+'').replace(/[.?*+^$[\]\\(){}|-]/g,'\\$&')},u=function(t,n,i,a){var r=function(t){var n=e(t);e.each(t.attributes,function(t,r){if(e.type(r.value)==='string'){n.attr(r.name.replace(i,a),r.value.replace(i,a))}});e.each(n.data(),function(t,r){if(e.type(r)==='string'){n.data(t.replace(i,a),r.replace(i,a))}})},o=t.eq(n);r(o[0]);o.find('*').each(function(){r(this)})},f=function(t,n,i,a,o,l){var d=new RegExp(r(i.name_prefix+'['+o+']'),'g'),f=i.name_prefix+'['+l+']';if(i.children){e.each(i.children,function(e,n){var r=t.find(n.selector).eq(a),i=r.data('collection-settings');if(i){i.name_prefix=i.name_prefix.replace(d,f);r.data('collection-settings',i)}})};u(n,a,d,f);d=new RegExp(r(t.attr('id')+'_'+o),'g');f=t.attr('id')+'_'+l;u(n,a,d,f)},b=function(e,t,n,i,a,o,f){var l=new RegExp(r(t.name_prefix+'['+o+']'),'g'),d=t.name_prefix+'['+f+']';n=n.replace(l,d);l=new RegExp(r(e.attr('id')+'_'+i),'g');d=e.attr('id')+'_'+a;n=n.replace(l,d);return n},j=function(t){e(t).find(':input').each(function(e,t){d(t,c(t),!0)})},i=function(e,t,n,i){var a=e.data('collection-settings');if(!a.position_field_selector&&!a.preserve_names){f(e,t,a,n,n,'__swap__');f(e,t,a,i,i,n);f(e,t,a,n,'__swap__',i)};t.eq(n).insertBefore(t.eq(i));if(i>n){t.eq(i).insertBefore(t.eq(n))}
else{t.eq(i).insertAfter(t.eq(n))};return e.find(a.elements_selector)},p=function(e,t,n,a,r){for(var o=a+1;(o<=r);o++){t=i(e,t,o,o-1)};return e.find(n.elements_selector)},h=function(e,t,n,a,r){for(var o=a-1;(o>=r);o--){t=i(e,t,o,o+1)};return e.find(n.elements_selector)},m=function(e,t,n,a){for(var r=a+1;r<t.length;r++){t=i(e,t,r-1,r)};return e.find(n.elements_selector)},q=function(e,t,n,a){for(var r=t.length-2;r>a;r--){t=i(e,t,r+1,r)};return e.find(n.elements_selector)},o=function(n,t,i,r){var f=e(t.elements_parent_selector),m=f.find('.'+t.prefix+'-tmp').length===0,a=n.find(t.elements_selector);if(t.allow_add){if(m){f.append('<span class="'+t.prefix+'-tmp"></span>');if(t.add){n.append(e(t.add).addClass(t.prefix+'-action '+t.prefix+'-rescue-add').data('collection',n.attr('id')))}}};if(i){var p=e(t.container),h=n.find('.'+t.prefix+'-add, .'+t.prefix+'-rescue-add, .'+t.prefix+'-duplicate').first();while(a.length<t.init_with_n_elements){var c=a.length>0?a.last():undefined,u=a.length-1;a=x(p,h,n,t,a,c,u,!1)}};n.data('last-index',a.length-1);a.each(function(o){var d=e(this);if(i){d.data('index',o)};var s=d.find('.'+t.prefix+'-actions').addBack().filter('.'+t.prefix+'-actions');if(s.length===0){s=e('<div class="'+t.prefix+'-actions"></div>');d.append(s)};var f=0;if(r==='remove'&&t.fade_out){f=1};var c=[{'enabled':t.allow_remove,'selector':t.prefix+'-remove','html':t.remove,'condition':a.length-f>t.min},{'enabled':t.allow_up,'selector':t.prefix+'-up','html':t.up,'condition':a.length-f>1&&a.index(d)-f>0},{'enabled':t.allow_down,'selector':t.prefix+'-down','html':t.down,'condition':a.length-f>1&&a.index(d)!==a.length-1},{'enabled':t.allow_add&&!t.add_at_the_end&&!t.custom_add_location,'selector':t.prefix+'-add','html':t.add,'condition':a.length-f<t.max},{'enabled':t.allow_duplicate,'selector':t.prefix+'-duplicate','html':t.duplicate,'condition':a.length-f<t.max}];e.each(c,function(i,a){if(a.enabled){var r=d.find('.'+a.selector);if(r.length===0&&a.html){r=e(a.html).appendTo(s).addClass(a.selector)};if(a.condition){r.removeClass(t.prefix+'-action-disabled');if(t.hide_useless_buttons){r.css('display','')}}
else{r.addClass(t.prefix+'-action-disabled');if(t.hide_useless_buttons){r.css('display','none')}};r.addClass(t.prefix+'-action').data('collection',n.attr('id')).data(t.prefix+'-element',l(n.attr('id')+'_'+o,d))}
else{d.find('.'+a.selector).css('display','none')}})});if(t.allow_add){var d=0;if(r==='remove'&&t.fade_out){d=1};var o=n.find('.'+t.prefix+'-rescue-add').css('display','').removeClass(t.prefix+'-action-disabled'),s=n.find('.'+t.prefix+'-add');if(!t.add_at_the_end&&s.length>d||t.custom_add_location){o.css('display','none')}
else if(r==='remove'&&t.fade_out){o.css('display','none');o.fadeIn('fast')};if(a.length-d>=t.max){o.addClass(t.prefix+'-action-disabled');if(t.hide_useless_buttons){n.find('.'+t.prefix+'-add, .'+t.prefix+'-rescue-add, .'+t.prefix+'-duplicate').css('display','none')}}}},v=function(t,n,i){if(i.children){e.each(i.children,function(e,i){if(!i.selector){console.log('jquery.collection.js: given collection '+t.attr('id')+' has children collections, but children\'s root selector is undefined.');return!0};if(n!==null){n.find(i.selector).collection(i)}
else{t.find(i.selector).collection(i)}})}},x=function(t,l,d,i,f,x,u,y){if(f.length<i.max&&(y&&n(i.before_duplicate(d,x))||n(i.before_add(d,x)))){var M=d.data('prototype'),p=d.data('last-index')+1;d.data('last-index',p);if(u===-1){u=f.length-1};var D=new RegExp(r(i.prototype_name),'g'),h=p;if(i.preserve_names){h=d.data('collection-free-key');if(h===undefined){h=B(i,f)};d.data('collection-free-key',h+1)};var c=e(M.replace(D,h)).data('index',p),A=e(i.elements_parent_selector),k=A.find('> .'+i.prefix+'-tmp'),F=e(c).find('[id]').first().attr('id');if(y){var w=f.eq(u);j(w);var E=e('<div/>').append(w.clone()).html(),C=i.preserve_names||i.position_field_selector?w.data('index'):u,Q=i.preserve_names?g(i,w):C,R=b(d,i,E,C,p,Q,h);c=e('<div/>').html(R).contents().data('index',p);if(i.fade_in){c.hide()};k.before(c).find(i.prefix+'-actions').remove()}
else{if(i.fade_in){c.hide()};k.before(c)};f=d.find(i.elements_selector);var q=c.find('.'+i.prefix+'-add, .'+i.prefix+'-duplicate');if(q.length>0){q.addClass(i.prefix+'-action').data('collection',d.attr('id'))};if(!i.add_at_the_end&&u+1!==p){f=s(d,i,f,c,p,u+1)}
else{o(d,i,!1)};v(d,c,i);if((y&&!n(i.after_duplicate(d,c)))||!n(i.after_add(d,c))){if(u!==-1){f=m(d,f,i,u+1)};c.remove()}};if(c!==undefined&&i.fade_in){c.fadeIn('fast',function(){if(i.position_field_selector){a(i,f)}})}
else{if(i.position_field_selector){return a(i,f)}};return f},C=function(t,i,r,o,l){if(r.length>i.min&&n(i.before_remove(t,o))){var d=function(){r=m(t,r,i,l);var o=r.last(),d=o.clone({withDataAndEvents:!0}).show();o.remove();if(!n(i.after_remove(t,d))){var f=e(i.elements_parent_selector);f.find('> .'+i.prefix+'-tmp').before(d);r=t.find(i.elements_selector);r=q(t,r,i,l-1)};if(i.position_field_selector){a(i,r)}};if(i.fade_out){o.fadeOut('fast',function(){d()})}
else{d()}};return r},k=function(e,t,r,o,l){if(l!==0&&n(t.before_up(e,o))){r=i(e,r,l,l-1);if(!n(t.after_up(e,o))){r=i(e,r,l-1,l)}};if(t.position_field_selector){return a(t,r)};return r},E=function(e,t,r,o,l){if(l!==(r.length-1)&&n(t.before_down(e,o))){r=i(e,r,l,l+1);if(!n(t.after_down(e,r))){r=i(e,r,l+1,l)}};if(t.position_field_selector){return a(t,r)};return r},s=function(e,t,r,l,d,f){if(1===Math.abs(f-d)){r=i(e,r,d,f);if(!(f-d>0?n(t.after_up(e,l)):n(t.after_down(e,l)))){r=i(e,r,f,d)}}
else{if(d<f){r=p(e,r,t,d,f);if(!(f-d>0?n(t.after_up(e,l)):n(t.after_down(e,l)))){r=h(e,r,t,f,d)}}
else{r=h(e,r,t,d,f);if(!(f-d>0?n(t.after_up(e,l)):n(t.after_down(e,l)))){r=p(e,r,t,f,d)}}};o(e,t,!1);if(t.position_field_selector){return a(t,r)};return r},a=function(t,n){e(n).each(function(){var i=e(this);d(i.find(t.position_field_selector),n.index(i))});return n},g=function(e,t){var n=t.find(':input[name^="'+e.name_prefix+'["]').attr('name');return n.slice(e.name_prefix.length+1).split(']',1)[0]},B=function(t,n){var i=0;n.each(function(){var n=g(t,e(this));if(/^0|[1-9]\d*$/.test(n)&&n>=i){i=Number(n)+1}});return i},w=e(this);if(w.length===0){console.log('jquery.collection.js: given collection selector does not exist.');return!1};w.each(function(){var i=e.extend(!0,{},Q,t);if(e(i.container).length===0){console.log('jquery.collection.js: a container should exist to handle events (basically, a <body> tag).');return!1};var h=e(this);if(h.data('collection')!==undefined){var a=e('#'+h.data('collection'));if(a.length===0){console.log('jquery.collection.js: given collection id does not exist.');return!0}}
else{a=h};a=e(a);i.elements_parent_selector=i.elements_parent_selector.replace('%id%','#'+l('',a));if(!i.elements_parent_selector){i.elements_parent_selector='#'+l('',a);if(e(i.elements_parent_selector).length===0){console.log('jquery.collection.js: given elements parent selector does not return any object.');return!0}};if(!i.allow_add){i.allow_duplicate=!1;i.add_at_the_end=!1};if(i.init_with_n_elements>i.max){i.init_with_n_elements=i.max};if(i.min&&(!i.init_with_n_elements||i.init_with_n_elements<i.min)){i.init_with_n_elements=i.min};i.before_init(a);if(a.data('prototype')===null){console.log('jquery.collection.js: given collection field has no prototype, check that your field has the prototype option set to true.');return!0};if(a.data('prototype-name')!==undefined){i.prototype_name=a.data('prototype-name')};if(a.data('allow-add')!==undefined){i.allow_add=a.data('allow-add');i.allow_duplicate=a.data('allow-add')?i.allow_duplicate:!1};if(a.data('allow-remove')!==undefined){i.allow_remove=a.data('allow-remove')};if(a.data('name-prefix')!==undefined){i.name_prefix=a.data('name-prefix')};if(!i.name_prefix){console.log('jquery.collection.js: the prefix used in descendant field names is mandatory, you can set it using 2 ways:');console.log('jquery.collection.js: - use the form theme given with this plugin source');console.log('jquery.collection.js: - set name_prefix option to  \'{{ formView.myCollectionField.vars.full_name }}\'');return!0};if(i.preserve_names){i.allow_up=!1;i.allow_down=!1;i.drag_drop=!1;i.add_at_the_end=!0};if((typeof jQuery.ui!=='undefined'&&typeof jQuery.ui.sortable!=='undefined')&&a.hasClass('ui-sortable')){a.sortable('disable')};if(i.drag_drop&&i.allow_up&&i.allow_down){var u,p;if(typeof jQuery.ui==='undefined'||typeof jQuery.ui.sortable==='undefined'){i.drag_drop=!1}
else{a.sortable(e.extend(!0,{},{start:function(t,r){var o=a.find(i.elements_selector),l=r.item,d=e(this);if(!n(i.drag_drop_start(t,r,o,l))){d.sortable('cancel');return};r.placeholder.height(r.item.height());r.placeholder.width(r.item.width());u=o.index(l)},update:function(t,r){var l=a.find(i.elements_selector),o=r.item,d=e(this);d.sortable('cancel');if(!1===i.drag_drop_update(t,r,l,o)||!(p-u>0?n(i.before_up(a,o)):n(i.before_down(a,o)))){return};p=l.index(o);l=a.find(i.elements_selector);s(a,i,l,o,u,p)}},i.drag_drop_options))}};a.data('collection-settings',i);var m=e(i.container);m.off('click','.'+i.prefix+'-action').on('click','.'+i.prefix+'-action',function(t){var i=e(this),r=e('#'+i.data('collection')),n=r.data('collection-settings');if(undefined===n){var r=e('#'+i.data('collection')).find('.'+i.data('collection')+'-collection'),n=r.data('collection-settings');if(undefined===n){throw'Can\'t find collection: '+i.data('collection')}};var a=r.find(n.elements_selector),l=i.data(n.prefix+'-element')?e('#'+i.data(n.prefix+'-element')):undefined,f=l&&l.length?a.index(l):-1,d=null,s=i.is('.'+n.prefix+'-duplicate');if((i.is('.'+n.prefix+'-add')||i.is('.'+n.prefix+'-rescue-add')||s)&&n.allow_add){d='add';a=x(m,i,r,n,a,l,f,s)};if(i.is('.'+n.prefix+'-remove')&&n.allow_remove){d='remove';a=C(r,n,a,l,f)};if(i.is('.'+n.prefix+'-up')&&n.allow_up){d='up';a=k(r,n,a,l,f)};if(i.is('.'+n.prefix+'-down')&&n.allow_down){d='down';a=E(r,n,a,l,f)};o(r,n,!1,d);t.preventDefault()});o(a,i,!0);v(a,null,i);if(i.position_field_selector){var f=[],r=a.find(i.elements_selector);r.each(function(t){var n=e(this);f.push({position:parseFloat(c(n.find(i.position_field_selector))),element:n})});var g=function(e,t){return(e.position<t.position?-1:(e.position>t.position?1:0))};f.sort(g);e.each(f,function(t,n){var f=[];e(r).each(function(t){f.push(e(this).attr('id'))});var o=n.element,l=e.inArray(o.attr('id'),f);if(t!==l){r=s(a,i,r,o,l,t);d(o.find(i.position_field_selector),r.index(o))}})};i.after_init(a)});return!0}})(jQuery);