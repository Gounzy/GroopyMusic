{% extends "base.html.twig" %}

{% set image_url = contract.photo is not null ? contract.webPath(contract.photo) : 'images/live/live-6.jpg' %}

{% set artists_str = '' %}
{% for artist in contract.allArtists %}
    {% if not loop.first and loop.last %}
         {% set artists_str = artists_str ~ ' & '%}
    {% elseif not loop.first %}
        {% set artists_str = artists_str ~ ', '%}
    {% endif %}
    {% set artists_str = artists_str ~ artist.artistname %}
{% endfor %}
{% block description_part_1 %}{{ 'meta_description_event'|trans({'%artists%': artists_str}) }}{% endblock %}

{% block headtitle %}
    {{ contract.getTitle }}
{% endblock %}

{% block open_graph %}
    <meta property="og:title"
          content="{{ contract.getTitle }}"/>
    <meta property="og:type" content="article"/>
    <meta property="og:url"
          content="{{ url(app.request.attributes.get('_route'), app.request.attributes.get('_route_params')) }}"/>
    <meta property="og:image" content="{{ absolute_url(asset(image_url)) }}"/>
{% endblock %}

{% block header %}
    {% include ':patterns:header.html.twig' with {'title': contract.getTitle ~ '<br />' ~ contract.getDisplayDates, 'img': absolute_url(asset(image_url)), 'img_absolute':true} %}
{% endblock %}

{% set state = contract.state %}
{% set nb_contracts_ok = 0 %}

{% set first_counterpart = contract.firstCounterPart %}
{% set progress_100 = contract.percentObjective %}

{% set visiblePromos = contract.currentPromotionsVisible %}

{% block body %}
    {% include ':patterns:crowdfunding.html.twig' with {'contractArtist': contract} %}

    <section class="container-fluid p-5">
        <div class="row">
            <div class="col-8 text-left">
                <p class="font-weight-bold w-md-75">{{ contract.description }}</p>
            </div>
            <div class="col-4 text-right">
                <a class="btn btn-primary scroll" href="#tickets">Tickets</a>
            </div>
        </div>
    </section>

     <section class="container-fluid p-5">
        <div class="row">
            <div class="col-md-5">
                <div class="form-block">
                    <div class="form-header">
                        <h2>Line-up</h2>
                    </div>
                    <div class="form-body">

                    </div>
                </div>
            </div>
            <div class="col-md-7">
                {% if visiblePromos is not empty or contract.isInCampaign %}
                    {% set endSentence = visiblePromos|length > 1 ? "des promotions (non cumulables) suivantes" : "de la promotion suivante" %}

                    <h2 class="text-center">Promotions</h2>
                    {% if not contract.inTestPeriod %}
                        <p class="text-center">Tout au long de la campagne, profitez {{ endSentence }} :</p>
                    {% else %}
                        <p class="text-center">Pendant les premiers jours de campagne, profitez {{ endSentence }} :</p>
                    {% endif %}
                    {% for promo in visiblePromos %}
                        {{ promo.left }} {{ promo.right }}
                    {% endfor %}
                    {# if contract.isInCampaign %}
                        <p class="text-center">1 commande passée avant la date de validation <i class='fas fa-long-arrow-alt-right'></i> <span class="text-secondary font-weight-bold">accès au bar Vedett all-in à 18h</span></p>
                    {% endif #}
                {% endif %}

                {% if not contract.hasNoDefinedHall %}
                    <div class="form-block mt-5 mx-auto w-50">
                        <div class="form-header">
                            <h2>{{ 'event.hall.known'|trans|raw }}</h2>
                        </div>
                        <div class="form-body">
                            <div id="carouselPotentialHalls" class="carousel slide" data-ride="carousel">
                                <div class="carousel-inner">
                                    {% set i = 0 %}
                                    {% for hall in contract.uniqueFestivalHalls if hall is not null %}
                                        <div class="carousel-item {% if loop.first %}active{% endif %}">
                                            {% include 'AppBundle:Public/Card:hall.html.twig' with {'xs': 12, 'md':12, 'no_rotation_hall':true} %}
                                        </div>
                                        {% set i = i + 1 %}
                                    {% endfor %}
                                </div>
                                {% if i > 1 %}
                                    <a class="carousel-control-prev" href="#carouselPotentialHalls" role="button"
                                       data-slide="prev">
                        <span class="carousel-control-prev-icon rounded-circle btn-primary bg-primary p-1"
                              aria-hidden="true"></span>
                                        <span class="sr-only">Previous</span>
                                    </a>
                                    <a class="carousel-control-next" href="#carouselPotentialHalls" role="button"
                                       data-slide="next">
                        <span class="carousel-control-next-icon rounded-circle btn-primary bg-primary p-1"
                              aria-hidden="true"></span>
                                        <span class="sr-only">Next</span>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
     </section>





    <div id="tickets"></div>
    {% if state not in contract.uncrowdableStates %}
        {% include ':patterns:tickets.html.twig' with {'contractArtist': contract, 'contract': form} %}
    {% else %}
        <p class="text-uppercase small text-center font-weight-bold">{{ 'event.buy_tickets.over'|trans|raw }}</p>
    {% endif %}

{% endblock %}

{% block additional_javascripts %}
        {% if (contract.crowdable or contract.pending) and contract.festivalDates is not empty %}
            <script type="application/ld+json">
            {
              "@context": "http://schema.org",
              "@type": "Event",
              "name": "{{ contract.getTitle }}",
              {% set firstdate = contract.festivalDates|first %}
              {% set lastdate = contract.festivalDates|last %}
              "startDate": "{{ firstdate|date('Y-m-d\\TH:i') }}",
              "endDate": "{{ lastdate|date('Y-m-d') }}T23:59",
              {% if not contract.hasNoDefinedHall %}
                {% set firsthall = contract.firstHall %}
              "location": {
                "@type": "Place",
                "name": "{{ firsthall.name }}",
                "address": {
                  "@type": "PostalAddress",
                  "streetAddress": "{{ firsthall.address.naturalStreet }}",
                  "addressLocality": "{{ firsthall.address.city }}",
                  "postalCode": "{{ firsthall.address.zipcode }}",
                  "addressCountry": "{{ firsthall.address.country }}"
                }
              },
              {% endif %}
              "image": [
                  "{{ absolute_url(asset(image_url)) }}"
               ],
              "description": "{{ contract.getDescription() }}",
              "offers": {
                "@type": "Offer",
                "url": "{{ url('artist_contract', {'id': contract.id}) }}",
                "price": "{{ first_counterpart.price }}",
                "priceCurrency": "EUR",
                "availability": "{{ contract.soldOut ? "http://schema.org/OutOfStock" : "http://schema.org/InStock" }}",
                "validFrom": "{{ contract.startDate|date('Y-m-d') }}"
              },
              "performer": [
                {% for artist in contract.allArtists %}
                {
                  "@type": "MusicGroup",
                  "name": "{{ artist.artistname }}"
                  {% set artist_link = artist.website is not null ? artist.website : artist.facebook is not null ? artist.facebook : artist.bandcamp is not null ? artist.bandcamp : null %}
                  {% if  artist_link is not null%}
                      ,"sameAs": [
                        "{{ artist_link }}"
                      ]
                  {% endif %}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
               ],
            }
        </script>
    {% endif %}
{% endblock %}