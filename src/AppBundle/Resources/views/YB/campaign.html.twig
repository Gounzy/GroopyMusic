{% extends 'yb/base.html.twig' %}
{% trans_default_domain 'yb' %}

{% block headtitle %}{{ campaign.getTitle }}{% endblock %}
{% block meta_description %}{{ campaign.getDescription|slice(0,100) }}{% endblock %}
{% set photo = campaign.photo is not null ? campaign.photo : false %}

{% block open_graph %}
    {% set og_src = photo ? asset(campaign.webPath(photo)) : asset('yb/images/illustration-guitars.jpg') %}
    <meta property="og:title"
          content="{{ campaign.getTitle }}"/>
    <meta property="og:type" content="article"/>
    <meta property="og:url"
          content="{{ url(app.request.attributes.get('_route'), app.request.attributes.get('_route_params')) }}"/>
    <meta property="og:image" content="{{ absolute_url(og_src) }}"/>
{% endblock %}

{% block header_container %}
    <header class="masthead campaign-masthead text-white" {% if photo %}style="background-image: url('{{ yb_asset(campaign.webPath(photo)) }}');"{% endif %} >
        <div class="overlay"></div>
        <div class="container">
            <div class="row">
                <div class="col-xl-9 mx-auto">
                    <h1 class="mb-5">{{ campaign.getTitle }}</h1>
                </div>
            </div>
        </div>
    </header>
{% endblock %}

{% block body %}
    <div class="container py-4">
        {% set is_event = campaign.dateEvent is not null %}

        <div class="row">
            <div class="col-12 col-lg-7">
                {% if is_event %}
                    <div class="mb-2">
                        <b>Date : {{ campaign.dateEvent|date('d/m/Y') }}</b>
                    </div>
                {% endif %}

                {{ campaign.getDescription|raw|nl2br }}

                {% if campaign.campaignPhotos is not empty %}
                    {% for photo in campaign.campaignPhotos %}
                        <img class="img-fluid d-block py-3 mx-auto" src="{{ yb_asset(campaign.webPath(photo)) }}" />
                    {% endfor %}
                {% endif %}
            </div>

            <div class="col-12 col-lg-5">
                {% if not campaign.noThreshold %}
                    <div>
                        <h3>Financement participatif</h3>
                        {% if campaign.successful %}
                            <p>Cet événement a fait l'objet d'une campagne de financement participatif et est <b>confirmé</b>. Si vous commandez des tickets, vous les recevrez immédiatement.</p>
                        {% elseif campaign.failed %}
                            <p>Cet événement a fait l'objet d'une campagne de financement participatif et est <b>annulé</b> parce que l'objectif de la campagne n'a pas été atteint. Les acheteurs ont été intégralement remboursés.</p>
                        {% elseif campaign.pending %}
                            <p>Le financement participatif a eu lieu et aujourd'hui est la <b>date de validation</b> de cet événement.</p>
                            {% if campaign.pendingSuccessful %}
                                <p>Si vous avez acheté vos tickets, ils vous seront très bientôt envoyés.</p>
                            {% else %}
                                <p>En fonction de la décision de l'organisateur, la campagne peut se poursuivre (vous recevrez alors vos tickets si vous en avez commandé, et vous pourrez à nouveau en commander) ou s'annuler (vous serez alors remboursé si vous avez acheté des tickets).</p>
                            {% endif %}
                        {% else %}
                            <p>Cet événement ne sera confirmé que si son organisateur estime qu'il a atteint son objectif à la date de validation (le {{ campaign.dateEnd|date('d/m/Y') }})</p>
                        {% endif %}
                        <p>Avancement actuel par rapport à l'objectif initial :</p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped{% if campaign.successful or campaign.pendingSuccessful %} bg-success{% elseif campaign.failed %} bg-danger{% endif %}" role="progressbar" style="width: {{ campaign.percentObjective }}%" aria-valuenow="{{ campaign.percentObjective }}" aria-valuemin="0" aria-valuemax="100">{{ campaign.percentObjective }}%</div>
                        </div>
                    </div>
                {% endif %}
                <div {% if not campaign.noThreshold %}class="mt-4"{% endif %}>
                    <h3>Commander{% if is_event %} des tickets{% endif %}</h3>

                    {% if campaign.isCrowdable %}
                        {{ form_start(form) }}

                        {% for purchase in form.purchases %}
                            {% set counterpart = purchase.vars.value.counterpart %}
                            <div class="counterpart-form p-3 my-2 border">

                                <div class="form-group form-row">
                                    {{ form_errors(purchase) }}

                                    <div class="col-8 col-sm-9 col-lg-8">
                                        <label class="font-weight-bold">{{ counterpart.name }}{% if counterpart.freePrice %} (prix libre){% endif %}</label>
                                    </div>
                                    {% if counterpart.freePrice %}
                                        <div class="col-4 col-sm-3 col-lg-4">
                                            <div class="w-90 position-relative mb-2">
                                                {{ form_widget(purchase.free_price_value, {'attr': {'min': counterpart.minimumPrice, 'value': counterpart.minimumPrice}}) }} <span class="free-price-euro-sign position-absolute">€</span>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="col-4 col-sm-3 col-lg-4">
                                        {% if counterpart.isFree %}Gratuit{% else %}{{ counterpart.price }} €{% endif %}
                                        </div>
                                    {% endif %}
                                    <div class="col-8 col-sm-9 col-lg-8">{{ counterpart.getDescription|raw }}</div>
                                    <div class="col-4 col-sm-3 col-lg-4">
                                        <div class="container px-0">
                                            <div class="input-group">
                                                <span class="input-group-btn">
                                                    <button type="button" class="quantity-left-minus btn btn-secondary btn-number"  data-type="minus" data-field="">
                                                        <i class="text-white fas fa-minus"></i>
                                                    </button>
                                                </span>
                                                {{ form_widget(purchase.quantity) }}
                                                <span class="input-group-btn">
                                                    <button type="button" class="quantity-right-plus btn btn-secondary btn-number" data-type="plus" data-field="">
                                                        <i class="text-white fas fa-plus"></i>
                                                    </button>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}

                        {{ form_widget(form.submit) }}

                        {{ form_end(form) }}
                    {% else %}
                        {% if campaign.passed %}
                            <p>Cette campagne est terminée et il n'est donc plus possible d'acheter des tickets.</p>
                        {% elseif campaign.pending %}
                            <p>Il n'est actuellement pas possible de contribuer à cette campagne car elle est en cours d'examination par son organisateur. Vous saurez bientôt si elle est validée ou non.</p>
                        {% else %}
                            <p>Il n'est actuellement pas possible d'acheter des tickets.</p>
                        {% endif %}
                    {% endif %}
                </div>

                {% if campaign.address is not null %}
                    <div class="mt-4">
                        <h3>Lieu</h3>

                        <p>Adresse : {{ campaign.address }}</p>
                        <div class="embed-responsive embed-responsive-16by9">
                                    <iframe
                                            class="embed-responsive-item"
                                            frameborder="0" style="border:0"
                                            src="https://www.google.com/maps/embed/v1/place?key={{ maps_api_key }}&q={{ campaign.address|url_encode }}" allowfullscreen>
                        </iframe>
                        </div>
                    </div>

                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}