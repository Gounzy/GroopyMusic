{% extends "base.html.twig" %}

{% block stylesheets %}
    {{ parent() }}
    {% stylesheets '@CraueFormFlowBundle/Resources/assets/css/buttons.css' %}
        <link type="text/css" rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
{% endblock %}

{% block body %}
    <div class="container">
        <h2 class="text-center mb-4">{{ 'new_event.title'|trans|raw }}</h2>
        {% if no_artist is defined %}
            <p>{{ 'new_event.empty'|trans({'%url%': path('user_new_artist')})|raw }}</p>
        {% else %}
            {% form_theme form ':Form:bootstrap_4_layout.html.twig' %}

            <div class="content-box">
                <div class="content-box-content">
                    <h3>{{ 'new_event.step'|trans|raw }} {{ flow.currentStepNumber }}/{{ flow.lastStepNumber }} : {{ flow.currentStepLabel|trans|raw }} </h3>
                    {% if flow.currentStepNumber == 1 %}
                        <p>
                            {{ 'new_event.step_1.intro'|trans|raw }}
                        </p>
                    {% endif %}

                    {% if flow.currentStepNumber == flow.lastStepNumber %}
                        <ul class="um-list">
                            <li>{{ 'new_event.step_3.recap.artist'|trans|raw }} : {{ contract.artist }}</li>
                            <li>{{ 'new_event.step_3.recap.province'|trans|raw }} : {{ contract.province is empty ? 'Sans importance' : contract.province }}</li>
                            <li>{{ 'new_event.step_3.recap.date'|trans|raw }} : {{ contract.preferences.date|date('d/m/Y') }}</li>
                            {% if contract.motivations is not empty %}
                                <li>{{ 'new_event.step_3.recap.motivations'|trans|raw }} : <br />{{ contract.motivations|nl2br }}</li>
                            {% endif %}
                            {% if contract.preferences.additionalInfo is not empty %}
                                <li>{{ 'new_event.step_3.recap.additional_info'|trans|raw }} : <br />{{ contract.preferences.additionalInfo|nl2br }}</li>
                            {% endif %}
                        </ul>
                    {% endif %}

                    {{ form_start(form) }}
                    {% if flow.currentStepNumber == 2 %}
                        <div class="form-group form-row">
                            <div class="col-12">
                                {{ form_errors(form.preferences.date) }}
                                {{ form_label(form.preferences.date) }}
                            </div>
                            <div class="col-12">
                                <table>
                                    <tbody>
                                    <tr>
                                        <td class="align-middle">
                                            {{ form_widget(form.preferences.date) }}
                                        </td>
                                        <td class="align-middle pl-4">
                                            <p class="datePicker-vis"></p>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {{ form_row(form.motivations) }}
                        {{ form_row(form.preferences.additional_info) }}

                    {% elseif flow.currentStepNumber == flow.lastStepNumber %}

                        {{ form_errors(form.accept_conditions) }}
                        {{ form_widget(form.accept_conditions) }}

                        {% if is_granted('ROLE_ADMIN') %}
                            <div class="form-group form-row mt-3">
                                <div class="contract-info-title">Admin</div>

                                <div class="col-12">
                                    {{ form_errors(form.testPeriod) }}
                                    {{ form_widget(form.testPeriod) }}
                                </div>
                                <div class="col-12">
                                    {{ form_row(form.reality.hall) }}
                                </div>

                                <div class="col-12">
                                    {{ form_errors(form.reality.date) }}
                                    {{ form_label(form.reality.date) }}
                                </div>
                                <div class="col-12">
                                    <table>
                                        <tbody>
                                        <tr>
                                            <td class="align-middle">
                                                {{ form_widget(form.reality.date) }}
                                            </td>
                                            <td class="align-middle pl-4">
                                                <p class="datePicker-vis">{{ "new_event.step_2.date_preview"|trans|raw }} {{ contract.preferences.date|date('d/m/Y') }}</p>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        {% endif %}

                    {% endif %}

                    {{ form_rest(form) }}
                    {% include '@CraueFormFlow/FormFlow/buttons.html.twig' with {
                        craue_formflow_button_class_last: 'btn btn-primary mr-3 mt-2 mt-md-0',
                        craue_formflow_button_class_back: 'btn btn-secondary mr-3 mt-2 mt-md-0',
                        craue_formflow_button_class_reset: 'btn btn-outline-warning mr-3 mt-2 mt-md-0',
                        } %}
                </div>
            </div>
        {% endif %}

    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        $('document').ready(function() {
            var $datePicker = $('.datePicker');
            var availableDates = $datePicker.attr('available-dates').toString().split(',');

            function available(d) {
                var mdy = ("0"+(d.getMonth()+1)).slice(-2) + "/" + ("0" + d.getDate()).slice(-2) + "/" +
                        d.getFullYear();

                if($.inArray(mdy, availableDates) < 0) {
                    return false;
                }
                return true;
            }

            function get_default_date() {
                var date = new Date();
                var i = 0;
                var stop = false;
                while(!available(date) && !stop) {
                    date.setDate(date.getDate()+1);
                    i++;
                    if(i == 120) {
                        stop = true;
                    }
                }
                if(stop) { return new Date(); }
                return date;
            }

            function dateToText(date) {
                var res = date.split('/');
                return res[1] + ' / ' + res[0] + ' / ' + res[2];
            }

            $datePicker.datepicker({
                beforeShowDay: function(d) {
                    return [available(d), ''];
                },
                defaultDate: get_default_date(),
                dateFormat: 'mm/dd/yy'
            });

            $datePicker.change(function() {
                $('.datePicker-vis').text('{{ "new_event.step_2.date_preview"|trans|raw }} ' + dateToText($datePicker.val()));
            });
        });
    </script>
{% endblock %}